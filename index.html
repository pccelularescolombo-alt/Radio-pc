<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>R√°dio Online - Pinheirinho Celulares</title>

<style>
/* ===============================
   RESET E BASE - ESTILO SPOTIFY
================================ */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    background: #121212;
    color: #fff;
    font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
    min-height: 100vh;
    padding-top: 64px;
    padding-bottom: 100px;
    overflow-x: hidden;
}

/* ===============================
   BARRA SUPERIOR - SPOTIFY STYLE
================================ */
.top-bar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 64px;
    background: linear-gradient(90deg, #007bff, #ff7a00);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 24px;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
}

.top-bar img {
    height: 40px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.top-bar img:hover {
    transform: scale(1.05);
    filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.5));
}

.top-bar img#loginIcon {
    width: 36px;
    height: 36px;
}

/* ===============================
   √ÅREA CENTRAL - SPOTIFY STYLE
================================ */
.center {
    max-width: 1200px;
    margin: 0 auto;
    text-align: center;
    padding: 40px 20px;
}

.center h1 {
    font-size: 3rem;
    font-weight: 700;
    letter-spacing: -0.04em;
    margin-bottom: 8px;
    background: linear-gradient(90deg, #007bff, #ff7a00);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.center p {
    font-size: 1.1rem;
    color: #b3b3b3;
    font-weight: 400;
}

/* ===============================
   VISUALIZADOR DE √ÅUDIO
================================ */
.visualizer-container {
    width: 100%;
    max-width: 1100px;
    height: 300px;
    margin: 40px auto;
    background: rgba(0,0,0,0.4);
    border-radius: 16px;
    overflow: hidden;
    position: relative;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

#visualizer {
    width: 100%;
    height: 100%;
    display: block;
}

.visualizer-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 60%;
    background: linear-gradient(to top, #121212, transparent);
    pointer-events: none;
}

/* ===============================
   BARRA INFERIOR - SPOTIFY STYLE
================================ */
.bottom-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: #181818;
    border-top: 1px solid #282828;
    padding: 12px 16px;
    z-index: 1000;
}

/* ===============================
   PLAYER WRAPPER - SPOTIFY LAYOUT
================================ */
.player-wrapper {
    width: 100%;
    max-width: 1800px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr 2fr 1fr;
    align-items: center;
    gap: 16px;
}

/* ===============================
   CONTROLES - SPOTIFY STYLE
================================ */
.controls-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.controls {
    display: flex;
    align-items: center;
    gap: 16px;
}

.controls img {
    width: 36px;
    height: 36px;
    cursor: pointer;
    opacity: 0.85;
    transition: all 0.2s ease;
}

.controls img:hover {
    opacity: 1;
    transform: scale(1.1);
    filter: drop-shadow(0 0 8px rgba(255, 122, 0, 0.6));
}

.controls img.main-btn {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, #007bff, #ff7a00);
    border-radius: 50%;
    padding: 10px;
    opacity: 1;
}

.controls img.main-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 0 20px rgba(255, 122, 0, 0.5);
}

.controls img.active {
    filter: drop-shadow(0 0 10px rgba(255, 122, 0, 0.8));
    opacity: 1;
}

/* ===============================
   VOLUME CONTROLS
================================ */
.volume-controls {
    display: flex;
    align-items: center;
    gap: 12px;
}

.volume-controls img {
    width: 28px;
    height: 28px;
    cursor: pointer;
    opacity: 0.85;
    transition: all 0.2s ease;
}

.volume-controls img:hover {
    opacity: 1;
    transform: scale(1.1);
    filter: drop-shadow(0 0 6px rgba(255, 122, 0, 0.5));
}

/* ===============================
   TRACK INFO - SPOTIFY STYLE
================================ */
.track-section {
    display: flex;
    flex-direction: column;
    gap: 6px;
    min-width: 0;
}

.now-playing {
    display: flex;
    align-items: center;
    gap: 12px;
}

.track-art {
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, #007bff, #ff7a00);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.track-art span {
    font-size: 24px;
}

.track-details {
    flex: 1;
    min-width: 0;
}

.track-name {
    font-size: 14px;
    font-weight: 500;
    color: #fff;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 2px;
}

.track-genre {
    font-size: 12px;
    color: #b3b3b3;
}

/* ===============================
   PROGRESS BARS - SPOTIFY STYLE
================================ */
.progress-section {
    display: flex;
    flex-direction: column;
    gap: 4px;
    width: 100%;
}

.progress-row {
    display: flex;
    align-items: center;
    gap: 8px;
}

.time-label {
    font-size: 11px;
    color: #a7a7a7;
    min-width: 45px;
    font-variant-numeric: tabular-nums;
}

.time-label.right {
    text-align: right;
}

.progress-container {
    flex: 1;
    position: relative;
    height: 4px;
    background: #404040;
    border-radius: 2px;
    cursor: pointer;
    transition: height 0.1s ease;
}

.progress-container:hover {
    height: 6px;
}

.progress-container:hover .progress {
    background: linear-gradient(90deg, #007bff, #ff7a00);
}

.progress-container:hover .dot {
    opacity: 1;
}

.progress {
    height: 100%;
    width: 0%;
    background: #fff;
    border-radius: 2px;
    transition: background 0.2s ease;
}

.dot {
    position: absolute;
    top: 50%;
    left: 0%;
    width: 12px;
    height: 12px;
    background: #fff;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    opacity: 0;
    transition: opacity 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

/* ===============================
   EXTRA INFO SECTION
================================ */
.extra-section {
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: flex-end;
}

.info-bar {
    background: #282828;
    border-radius: 8px;
    padding: 8px 12px;
    width: 100%;
    max-width: 280px;
}

.info-bar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
}

.info-bar-title {
    font-size: 11px;
    color: #b3b3b3;
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

.info-bar-time {
    font-size: 11px;
    color: #a7a7a7;
    font-variant-numeric: tabular-nums;
}

.info-bar .progress-container {
    height: 3px;
}

/* ===============================
   LOGIN BOX - SPOTIFY STYLE
================================ */
#loginBox {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #282828;
    padding: 32px;
    border-radius: 8px;
    display: none;
    flex-direction: column;
    gap: 16px;
    z-index: 2000;
    box-shadow: 0 16px 24px rgba(0,0,0,0.3);
    min-width: 300px;
}

#loginBox h3 {
    text-align: center;
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 8px;
}

#loginBox input {
    padding: 14px 16px;
    border: none;
    border-radius: 4px;
    background: #3e3e3e;
    color: #fff;
    font-size: 14px;
    outline: none;
    transition: background 0.2s ease;
}

#loginBox input:focus {
    background: #4a4a4a;
}

#loginBox input::placeholder {
    color: #a7a7a7;
}

#loginBox button {
    padding: 14px;
    background: linear-gradient(90deg, #007bff, #ff7a00);
    border: none;
    color: #fff;
    border-radius: 500px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    transition: all 0.2s ease;
}

#loginBox button:hover {
    transform: scale(1.02);
    box-shadow: 0 8px 16px rgba(255, 122, 0, 0.3);
}

/* ===============================
   PAINEL DE G√äNEROS - SPOTIFY STYLE
================================ */
#genrePanel {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 3000;
    backdrop-filter: blur(4px);
}

.genre-box {
    background: #282828;
    padding: 32px;
    border-radius: 8px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 16px 24px rgba(0,0,0,0.3);
}

.genre-box h3 {
    text-align: center;
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 24px;
}

#genreList {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 16px;
    padding-right: 8px;
}

#genreList::-webkit-scrollbar {
    width: 8px;
}

#genreList::-webkit-scrollbar-track {
    background: #181818;
    border-radius: 4px;
}

#genreList::-webkit-scrollbar-thumb {
    background: #404040;
    border-radius: 4px;
}

#genreList::-webkit-scrollbar-thumb:hover {
    background: #505050;
}

#genreList button {
    background: #3e3e3e;
    color: #fff;
    padding: 12px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    text-align: center;
    transition: all 0.2s ease;
}

#genreList button:hover {
    background: linear-gradient(90deg, #007bff, #ff7a00);
    transform: scale(1.02);
}

.genre-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

#genrePanel .genre-actions button {
    padding: 14px;
    background: #3e3e3e;
    border: none;
    color: #fff;
    border-radius: 500px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.2s ease;
}

#genrePanel .genre-actions button:first-child {
    background: linear-gradient(90deg, #007bff, #ff7a00);
}

#genrePanel .genre-actions button:hover {
    transform: scale(1.02);
}

/* ===============================
   OVERLAY ESCURO
================================ */
.overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1999;
    display: none;
}

/* ===============================
   RESPONSIVO
================================ */
@media (max-width: 900px) {
    .player-wrapper {
        grid-template-columns: 1fr;
        gap: 12px;
    }

    .controls-section {
        order: 1;
    }

    .track-section {
        order: 0;
    }

    .extra-section {
        order: 2;
        align-items: stretch;
    }

    .info-bar {
        max-width: none;
    }

    .bottom-bar {
        padding: 16px;
    }

    body {
        padding-bottom: 280px;
    }
}

@media (max-width: 480px) {
    .center h1 {
        font-size: 2rem;
    }

    .now-playing {
        flex-direction: column;
        text-align: center;
    }

    .track-details {
        text-align: center;
    }

    .visualizer-container {
        height: 180px;
    }

    body {
        padding-bottom: 320px;
    }

    .controls img {
        width: 32px;
        height: 32px;
    }

    .controls img.main-btn {
        width: 44px;
        height: 44px;
    }

    .volume-controls img {
        width: 26px;
        height: 26px;
    }
}

/* ===============================
   SCROLLBAR GLOBAL
================================ */
::-webkit-scrollbar {
    width: 12px;
}

::-webkit-scrollbar-track {
    background: #121212;
}

::-webkit-scrollbar-thumb {
    background: #404040;
    border-radius: 6px;
}

::-webkit-scrollbar-thumb:hover {
    background: #505050;
}

/* ===============================
   ANIMA√á√ÉO LOADING
================================ */
@keyframes pulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
}

.loading {
    animation: pulse 1.5s ease-in-out infinite;
}
</style>
</head>

<body>

<!-- PAINEL DE G√äNEROS -->
<div id="genrePanel" style="display:none">
    <div class="genre-box">
        <h3>Selecionar G√™nero</h3>
        <div id="genreList"></div>
        <div class="genre-actions">
            <button onclick="autoGenre()">üîÄ Sele√ß√£o Autom√°tica</button>
            <button onclick="closeGenrePanel()">‚úï Fechar</button>
        </div>
    </div>
</div>

<!-- OVERLAY -->
<div class="overlay" id="overlay"></div>

<!-- BARRA SUPERIOR -->
<div class="top-bar">
    <img src="imagens/logo.png" alt="Logo" onclick="location.reload()">
    <img id="loginIcon" src="icon/login.png" onclick="toggleLogin()" title="Login Admin">
</div>

<!-- √ÅREA CENTRAL -->
<div class="center">
    <h1>R√°dio Online</h1>
    <p>Pinheirinho Celulares</p>
    
    <!-- VISUALIZADOR DE BATIDAS -->
    <div class="visualizer-container">
        <canvas id="visualizer"></canvas>
        <div class="visualizer-overlay"></div>
    </div>
</div>

<!-- BARRA INFERIOR -->
<div class="bottom-bar">
    <div class="player-wrapper">

        <!-- TRACK INFO -->
        <div class="track-section">
            <div class="now-playing">
                <div class="track-art">
                    <span>üéµ</span>
                </div>
                <div class="track-details">
                    <div class="track-name" id="trackName">Nenhuma m√∫sica</div>
                    <div class="track-genre">G√™nero: <span id="genreName">---</span></div>
                </div>
            </div>
        </div>

        <!-- CONTROLES CENTRAIS -->
        <div class="controls-section">
            <div class="controls">
                <img id="genreBtn" src="icon/genero.png" onclick="openGenres()" style="display:none;" title="G√™neros">
                <img id="nextBtn" src="icon/proximo.png" onclick="nextMusic()" style="display:none;" title="Pr√≥xima">
                <img id="playBtn" src="icon/play.png" onclick="togglePlay()" class="main-btn" title="Play/Pause">
            </div>
            
            <!-- BARRA DE PROGRESSO DA M√öSICA -->
            <div class="progress-section">
                <div class="progress-row">
                    <span class="time-label" id="currentTime">0:00</span>
                    <div class="progress-container" id="musicProgressContainer">
                        <div class="progress" id="musicProgress"></div>
                        <div class="dot" id="musicDot"></div>
                    </div>
                    <span class="time-label right" id="totalTime">0:00</span>
                </div>
            </div>

            <!-- VOLUME -->
            <div class="volume-controls">
                <img src="icon/diminuir.png" onclick="volumeDown()" title="Diminuir">
                <img id="muteBtn" src="icon/mute.png" onclick="toggleMute()" title="Mudo">
                <img src="icon/aumenta.png" onclick="volumeUp()" title="Aumentar">
            </div>
        </div>

        <!-- BARRAS DE INFO -->
        <div class="extra-section">
            <!-- BARRA DO G√äNERO -->
            <div class="info-bar">
                <div class="info-bar-header">
                    <span class="info-bar-title">G√™nero</span>
                    <span class="info-bar-time" id="genreInfo">00:00:00 / 00:00:00</span>
                </div>
                <div class="progress-container">
                    <div class="progress" id="genreProgress"></div>
                    <div class="dot" id="genreDot"></div>
                </div>
            </div>

            <!-- BARRA TOTAL GERAL -->
            <div class="info-bar">
                <div class="info-bar-header">
                    <span class="info-bar-title">Total Geral</span>
                    <span class="info-bar-time" id="globalInfo">00:00:00 / 00:00:00</span>
                </div>
                <div class="progress-container">
                    <div class="progress" id="globalProgress"></div>
                    <div class="dot" id="globalDot"></div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- LOGIN BOX -->
<div id="loginBox">
    <h3>Login Admin</h3>
    <input id="user" placeholder="Usu√°rio" autocomplete="username">
    <input id="pass" type="password" placeholder="Senha" autocomplete="current-password">
    <button onclick="login()">Entrar</button>
</div>

<!-- AUDIO ELEMENT -->
<audio id="player" crossorigin="anonymous"></audio>

<script>
/* ===============================
   VARI√ÅVEIS GLOBAIS
================================ */
const player = document.getElementById("player");
const loginBox = document.getElementById("loginBox");
const loginIcon = document.getElementById("loginIcon");
const overlay = document.getElementById("overlay");
const nextBtn = document.getElementById("nextBtn");
const genreBtn = document.getElementById("genreBtn");
const playBtn = document.getElementById("playBtn");
const muteBtnEl = document.getElementById("muteBtn");
const user = document.getElementById("user");
const pass = document.getElementById("pass");

let isAdmin = false;
let tempoTotalGenero = 0;
let tempoGeneroTocado = 0;
let tempoTotalGeral = 0;
let tempoGeralTocado = 0;
let generoAtual = "";
let musicasTocadas = [];
let contadorMusicas = 0;
let tocandoDivulgacao = false;
let musicaAtualNome = "";

// Audio Visualizer
let audioContext = null;
let analyser = null;
let dataArray = null;
let animationId = null;
let isVisualizerInitialized = false;

/* ===============================
   BANCO DE M√öSICAS
================================ */
const musicas = {
    "Eletronica": [
        "Amine_Edge_DANCE_Lost.mp3",
        "Azari_III_Hungry_for_the_power.mp3",
        "Maverick_Sabre_Slow_Down_Ft_Jorja_Smith_Vintage_Culture.mp3",
        "Tiesto_The_Business.mp3",
    ],
    "Sertanejo": [
        "Felipe_Rodrigo_Gosta_de_Rua.mp3",
        "Gusttavo_Lima_Bloqueado.mp3",
        "Henrique_e_Juliano_Flor_E_O_Beija_Flor_part_Mar√≠lia_Mendon√ßa.mp3",
        "Henrique_e_Juliano_VIDINHA_DE_BALADA.mp3",
        "Henrique_e_Juliano_VOLTA_POR_BAIXO.mp3",
        "Hugo_e_Guilherme_Mar√≠lia_Mendon√ßa_Mal_Feito.mp3",
        "Jorge_Mateus_CHEIROSA.mp3",
        "Lauana_Prado_Saudade_Burra_feat_Simone_Mendes.mp3",
        "Len√ßol_Dobrado_Jo√£o_Gustavo_e_Murilo.mp3",
        "Luiza_e_Maur√≠lio_S_de_Saudade_part_Z√©_Neto_e_Cristiano.mp3",
        "Maiara__Maraisa_Medo_Bobo.mp3",
        "Mar√≠lia_Mendon√ßa_BEBI_LIGUEI.mp3",
        "Mar√≠lia_Mendon√ßa_CIUMEIRA.mp3",
        "Mar√≠lia_Mendon√ßa_Eu_Sei_De_Cor.mp3",
        "Mar√≠lia_Mendon√ßa_INTEN√á√ÉO_feat_Gaab.mp3",
        "Mar√≠lia_Mendon√ßa_Le√£o.mp3",
        "Mar√≠lia_Mendon√ßa_TODO_MUNDO_VAI_SOFRER.mp3",
        "Matheus_Kauan_Decide_A√≠.mp3",
        "Matheus_Kauan_O_Nosso_Santo_Bateu.mp3",
        "Os_Bar√µes_da_Pisadinha_Esquema_Preferido.mp3",
        "Simone_Mendes_DOIS_TRISTES.mp3",
        "Simone_Mendes_Daqui_Pra_Sempre.mp3",
        "Simone_Mendes_Saudade_Proibida.mp3",
        "Tayrone_C√™_T√°_Preparada_ft_Mar√≠lia_Mendon√ßa.mp3",
        "Tudo_Que_Voc√™_Quiser_Luan_Santana.mp3",
        "Z√©_Neto_Cristiano_Barulho_do_Foguete.mp3",
        "Z√©_Neto_Cristiano_LARGADO_√ÄS_TRA√áAS.mp3",
        "Z√©_Neto_Cristiano_STATUS_QUE_EU_N√ÉO_QUERIA.mp3",
    ],
    "Pop": [
        "Artemas_I_like_the_way_you_kiss_me.mp3",
        "Calvin_Harris_Sam_Smith_Promises.mp3",
        "Calvin_Harris_Thinking_About_You_ft_Ayah_Marar.mp3",
        "Duke_Dumont_Ocean_Drive.mp3",
        "Ed_Sheeran_Bad_Habits.mp3",
        "Empire_of_the_Sun_We_Are_The_People.mp3",
        "Gorgon_City_Imagination_ft_Katy_Menditta.mp3",
        "I_Follow_Rivers_Lykke_Li.mp3",
        "James_Hype_7_Seconds_ft_Shamira_Battles.mp3",
        "James_Hype_Drums_ft_Kim_Petras.mp3",
        "James_Hype_Miggy_Dela_Rosa_Ferrari.mp3",
        "Kendrick_Lamar_SZA_All_The_Stars.mp3",
        "MEDUZA_Becky_Hill_Goodboys_Lose_Control.mp3",
        "MEDUZA_Tell_It_To_My_Heart_ft_Hozier.mp3",
        "Mr_Probz_Waves.mp3",
        "Purple_Disco_Machine_Kungs_Substitution_ft_Julian_Perretta.mp3",
        "Sam_Smith_Unholy_ft_Kim_Petras.mp3",
        "Tame_Impala_The_Less_I_Know_The_Better.mp3",
        "The_Black_Eyed_Peas_Meet_Me_Halfway.mp3",
        "Zerb_The_Chainsmokers_Addicted_ft_Ink.mp3",
    ],
    "Pagode": [
        "Bebe_Vem_Me_Procura_Quem_Ama_Sente_Saudade.mp3",
        "Grupo_Menos_E_Mais_Aquele_Lugar.mp3",
        "Grupo_Menos_E_Mais_Jejum_de_Amor.mp3",
        "Grupo_Menos_E_Mais_Nattan_Pela_Ultima_Vez.mp3",
        "Grupo_Menos_E_Mais_Simone_Mendes_P_do_Pecado.mp3",
        "Grupo_Menos_e_Mais_Tarde_Demais.mp3",
        "Grupo_Revelacao_Deixa_Acontecer.mp3",
        "Melhor_eu_ir_Ligando_os_Fatos.mp3",
        "Pixote_Inseguranca.mp3",
        "Turma_do_Pagode_A_Gente_Tem_Tudo_Ver.mp3",
        "Turma_do_Pagode_Deixa_em_Off.mp3",
    ],
    "Anos80": [
        "ABBA_Dancing_Queen.mp3",
        "AC_DC_Back_In_Black.mp3",
        "Alan_Jackson_Chattahoochee.mp3",
        "Culture_Club_Karma_Chameleon.mp3",
        "Cyndi_Lauper_Girls_Just_Want_To_Have_Fun.mp3",
        "Desireless_Voyage_Voyage.mp3",
        "Going_Back_West.mp3",
        "Guns_N_Roses_Sweet_Child_O_Mine.mp3",
        "Journey_Dont_Stop_Believin.mp3",
        "Joy_Touch_By_Touch.mp3",
        "Laura_Branigan_Self_Control.mp3",
        "Modern_Talking_Atlantis_Is_Calling.mp3",
        "Modern_Talking_Brother_Louie.mp3",
        "Modern_Talking_Cheri_Cheri_Lady.mp3",
        "Queen_I_Want_To_Break_Free.mp3",
        "Sweet_Dreams.mp3",
        "The_Outfield_Your_Love.mp3",
    ],
    "Divulgacao": [
        "promo1.mp3",
        "promo2.mp3",
        "promo3.mp3",
        "promo4.mp3",
        "promo5.mp3",
    ]
};

/* ===============================
   VISUALIZADOR DE √ÅUDIO
================================ */
function initVisualizer() {
    if (isVisualizerInitialized) return;
    
    try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        
        const source = audioContext.createMediaElementSource(player);
        source.connect(analyser);
        analyser.connect(audioContext.destination);
        
        const bufferLength = analyser.frequencyBinCount;
        dataArray = new Uint8Array(bufferLength);
        
        isVisualizerInitialized = true;
        drawVisualizer();
    } catch (e) {
        console.warn("Visualizador n√£o dispon√≠vel:", e);
    }
}

function drawVisualizer() {
    const canvas = document.getElementById("visualizer");
    const ctx = canvas.getContext("2d");
    
    // Set canvas size
    canvas.width = canvas.offsetWidth * 2;
    canvas.height = canvas.offsetHeight * 2;
    ctx.scale(2, 2);
    
    const width = canvas.offsetWidth;
    const height = canvas.offsetHeight;
    
    function draw() {
        animationId = requestAnimationFrame(draw);
        
        if (!analyser || !dataArray) {
            // Draw idle state
            ctx.fillStyle = "rgba(18, 18, 18, 0.3)";
            ctx.fillRect(0, 0, width, height);
            
            const barCount = 64;
            const barWidth = width / barCount - 2;
            
            for (let i = 0; i < barCount; i++) {
                const barHeight = 5 + Math.sin(Date.now() / 500 + i * 0.2) * 3;
                const x = i * (barWidth + 2);
                
                const gradient = ctx.createLinearGradient(0, height - barHeight, 0, height);
                gradient.addColorStop(0, "#007bff");
                gradient.addColorStop(1, "#ff7a00");
                
                ctx.fillStyle = gradient;
                ctx.fillRect(x, height - barHeight, barWidth, barHeight);
            }
            return;
        }
        
        analyser.getByteFrequencyData(dataArray);
        
        ctx.fillStyle = "rgba(18, 18, 18, 0.3)";
        ctx.fillRect(0, 0, width, height);
        
        const barCount = dataArray.length;
        const barWidth = width / barCount - 1;
        
        for (let i = 0; i < barCount; i++) {
            const barHeight = (dataArray[i] / 255) * height * 0.9;
            const x = i * (barWidth + 1);
            
            const gradient = ctx.createLinearGradient(0, height - barHeight, 0, height);
            gradient.addColorStop(0, "#007bff");
            gradient.addColorStop(0.5, "#00c3ff");
            gradient.addColorStop(1, "#ff7a00");
            
            ctx.fillStyle = gradient;
            
            // Rounded bars
            const radius = barWidth / 2;
            ctx.beginPath();
            ctx.moveTo(x + radius, height);
            ctx.lineTo(x + radius, height - barHeight + radius);
            ctx.arc(x + radius, height - barHeight + radius, radius, Math.PI, 0, false);
            ctx.lineTo(x + barWidth - radius, height);
            ctx.fill();
        }
    }
    
    draw();
}

// Resize handler for canvas
window.addEventListener("resize", () => {
    const canvas = document.getElementById("visualizer");
    if (canvas) {
        canvas.width = canvas.offsetWidth * 2;
        canvas.height = canvas.offsetHeight * 2;
    }
});

/* ===============================
   LOGIN / LOGOUT
================================ */
function toggleLogin() {
    if (isAdmin) {
        logout();
    } else {
        openLogin();
    }
}

function openLogin() {
    user.value = "";
    pass.value = "";
    loginBox.style.display = "flex";
    overlay.style.display = "block";
    user.focus();
}

function login() {
    if (user.value === "admin" && pass.value === "1234") {
        isAdmin = true;
        nextBtn.style.display = "block";
        genreBtn.style.display = "block";
        loginIcon.src = "icon/sair.png";
        loginBox.style.display = "none";
        overlay.style.display = "none";
        user.value = "";
        pass.value = "";
    } else {
        alert("Usu√°rio ou senha inv√°lidos");
        pass.value = "";
        pass.focus();
    }
}

function logout() {
    isAdmin = false;
    nextBtn.style.display = "none";
    genreBtn.style.display = "none";
    loginIcon.src = "icon/login.png";
    loginBox.style.display = "none";
    overlay.style.display = "none";
    user.value = "";
    pass.value = "";
}

// Enter key login
document.getElementById("pass").addEventListener("keypress", (e) => {
    if (e.key === "Enter") login();
});

// Click overlay to close
overlay.addEventListener("click", () => {
    loginBox.style.display = "none";
    overlay.style.display = "none";
});

/* ===============================
   PLAYER CONTROLS
================================ */
function togglePlay() {
    if (!player.src) {
        iniciarRadio();
        return;
    }

    if (player.paused) {
        player.play();
        if (audioContext && audioContext.state === "suspended") {
            audioContext.resume();
        }
        playBtn.src = "icon/pause.png";
        playBtn.classList.add("active");
    } else {
        player.pause();
        playBtn.src = "icon/play.png";
        playBtn.classList.remove("active");
    }
}

function toggleMute() {
    player.muted = !player.muted;
    if (player.muted) {
        muteBtnEl.classList.add("active");
        muteBtnEl.src = "icon/volume.png";
    } else {
        muteBtnEl.classList.remove("active");
        muteBtnEl.src = "icon/mute.png";
    }
}

function volumeUp() { 
    player.volume = Math.min(1, player.volume + 0.1); 
}

function volumeDown() { 
    player.volume = Math.max(0, player.volume - 0.1); 
}

function nextMusic() {
    player.dispatchEvent(new Event("ended"));
}

/* ===============================
   L√ìGICA DA R√ÅDIO
================================ */
function iniciarRadio() {
    // Initialize visualizer on first play (requires user interaction)
    initVisualizer();
    
    // Calculate total time for all genres first
    calcularTempoGeral();
    
    // Choose genre and start playing
    escolherGeneroAutomatico();
    tocarProxima();
}

function escolherGeneroAutomatico() {
    const generos = Object.keys(musicas).filter(g => g !== "Divulgacao");
    generoAtual = generos[Math.floor(Math.random() * generos.length)];
    musicasTocadas = [];
    contadorMusicas = 0;
    tempoGeneroTocado = 0;
    
    resetarBarraGenero();
    document.getElementById("genreName").innerText = generoAtual;
    
    // CORRE√á√ÉO: Calcular tempo do g√™nero ANTES de tocar
    calcularTempoGenero(generoAtual);
}

function escolherGeneroManual(genero) {
    closeGenrePanel();
    
    generoAtual = genero;
    musicasTocadas = [];
    contadorMusicas = 0;
    tempoGeneroTocado = 0;
    tempoGeralTocado = 0;
    tocandoDivulgacao = false;
    
    resetarBarraGenero();
    resetarBarraGeral();
    
    document.getElementById("genreName").innerText = generoAtual;
    
    // CORRE√á√ÉO PRINCIPAL: Calcular tempo do g√™nero ANTES de tocar a m√∫sica
    // e aguardar o c√°lculo completar antes de tocar
    calcularTempoGenero(generoAtual, () => {
        // Recalcular tempo geral quando muda de g√™nero
        calcularTempoGeral(() => {
            tocarProxima();
        });
    });
}

function resetarBarraGenero() {
    document.getElementById("genreProgress").style.width = "0%";
    document.getElementById("genreDot").style.left = "0%";
    document.getElementById("genreInfo").innerText = "00:00:00 / 00:00:00";
}

function resetarBarraGeral() {
    document.getElementById("globalProgress").style.width = "0%";
    document.getElementById("globalDot").style.left = "0%";
    document.getElementById("globalInfo").innerText = "00:00:00 / 00:00:00";
}

function tocarProxima() {
    if (musicasTocadas.length === musicas[generoAtual].length) {
        escolherGeneroAutomatico();
    }

    let musica;
    do {
        musica = musicas[generoAtual][Math.floor(Math.random() * musicas[generoAtual].length)];
    } while (musicasTocadas.includes(musica));

    musicasTocadas.push(musica);
    tocarMusica(generoAtual, musica);
}

function tocarMusica(genero, arquivo) {
    musicaAtualNome = arquivo
        .replace(/_/g, " ")
        .replace(".mp3", "");

    document.getElementById("trackName").innerText = "Carregando...";
    document.getElementById("trackName").classList.add("loading");

    player.src = `musicas/${genero}/${arquivo}`;
    player.load();
    player.play();

    playBtn.src = "icon/pause.png";
    playBtn.classList.add("active");
}

function tocarDivulgacao() {
    const lista = musicas["Divulgacao"];
    if (!lista || lista.length === 0) {
        tocarProxima();
        return;
    }

    tocandoDivulgacao = true;
    const promo = lista[Math.floor(Math.random() * lista.length)];
    tocarMusica("Divulgacao", promo);
}

/* ===============================
   FORMATA√á√ÉO DE TEMPO
================================ */
function formatar(t) {
    if (isNaN(t) || !isFinite(t)) return "0:00";
    const m = Math.floor(t / 60);
    const s = Math.floor(t % 60).toString().padStart(2, "0");
    return `${m}:${s}`;
}

function formatarHMS(t) {
    if (isNaN(t) || !isFinite(t)) return "00:00:00";
    const h = Math.floor(t / 3600).toString().padStart(2, "0");
    const m = Math.floor((t % 3600) / 60).toString().padStart(2, "0");
    const s = Math.floor(t % 60).toString().padStart(2, "0");
    return `${h}:${m}:${s}`;
}

/* ===============================
   C√ÅLCULO DE TEMPO - CORRIGIDO
================================ */
function calcularTempoGenero(genero, callback) {
    tempoTotalGenero = 0;
    const lista = musicas[genero];
    
    if (!lista || lista.length === 0) {
        document.getElementById("genreInfo").innerText = "00:00:00 / 00:00:00";
        if (callback) callback();
        return;
    }

    let processadas = 0;
    const total = lista.length;

    lista.forEach(musica => {
        const audioTemp = new Audio(`musicas/${genero}/${musica}`);

        const finalizar = () => {
            processadas++;
            if (processadas === total) {
                // Atualiza a UI com o tempo total calculado
                document.getElementById("genreInfo").innerText = 
                    "00:00:00 / " + formatarHMS(tempoTotalGenero);
                
                // Chama callback quando terminar
                if (callback) callback();
            }
        };

        audioTemp.addEventListener("loadedmetadata", () => {
            if (!isNaN(audioTemp.duration) && isFinite(audioTemp.duration)) {
                tempoTotalGenero += audioTemp.duration;
            }
            finalizar();
        });

        audioTemp.addEventListener("error", () => {
            console.warn("Erro ao carregar:", musica);
            finalizar();
        });
        
        // Timeout para evitar travamento
        setTimeout(() => {
            if (processadas < total) {
                finalizar();
            }
        }, 5000);
    });
}

function calcularTempoGeral(callback) {
    tempoTotalGeral = 0;
    const generos = Object.keys(musicas).filter(g => g !== "Divulgacao");
    let processadas = 0;
    let totalMusicas = 0;

    // Contar total de m√∫sicas
    generos.forEach(genero => {
        totalMusicas += musicas[genero].length;
    });

    if (totalMusicas === 0) {
        if (callback) callback();
        return;
    }

    generos.forEach(genero => {
        musicas[genero].forEach(musica => {
            const audioTemp = new Audio(`musicas/${genero}/${musica}`);

            const finalizar = () => {
                processadas++;
                if (processadas === totalMusicas) {
                    document.getElementById("globalInfo").innerText = 
                        "00:00:00 / " + formatarHMS(tempoTotalGeral);
                    
                    if (callback) callback();
                }
            };

            audioTemp.addEventListener("loadedmetadata", () => {
                if (!isNaN(audioTemp.duration) && isFinite(audioTemp.duration)) {
                    tempoTotalGeral += audioTemp.duration;
                }
                finalizar();
            });

            audioTemp.addEventListener("error", finalizar);
            
            // Timeout
            setTimeout(() => {
                if (processadas < totalMusicas) {
                    finalizar();
                }
            }, 10000);
        });
    });
}

/* ===============================
   PAINEL DE G√äNEROS
================================ */
const genrePanel = document.getElementById("genrePanel");
const genreList = document.getElementById("genreList");

function openGenres() {
    if (!isAdmin) return;

    genreList.innerHTML = "";

    Object.keys(musicas).forEach(genero => {
        if (genero === "Divulgacao") return;

        const btn = document.createElement("button");
        btn.innerText = genero;
        btn.onclick = () => escolherGeneroManual(genero);
        genreList.appendChild(btn);
    });

    genrePanel.style.display = "flex";
}

function closeGenrePanel() {
    genrePanel.style.display = "none";
}

function autoGenre() {
    closeGenrePanel();
    tempoGeralTocado = 0;
    resetarBarraGeral();
    escolherGeneroAutomatico();
    
    // Recalcular tempo geral
    calcularTempoGeral(() => {
        tocarProxima();
    });
}

/* ===============================
   EVENT LISTENERS
================================ */

// Atualiza√ß√£o da barra de progresso
player.addEventListener("timeupdate", () => {
    if (!player.duration || isNaN(player.duration)) return;
    
    const pct = (player.currentTime / player.duration) * 100;
    
    // Barra da m√∫sica
    document.getElementById("musicProgress").style.width = pct + "%";
    document.getElementById("musicDot").style.left = pct + "%";
    document.getElementById("currentTime").innerText = formatar(player.currentTime);
    document.getElementById("totalTime").innerText = formatar(player.duration);

    // Barra do g√™nero
    if (tempoTotalGenero > 0) {
        const totalTocado = tempoGeneroTocado + (player.currentTime || 0);
        const pctGenero = Math.min((totalTocado / tempoTotalGenero) * 100, 100);

        document.getElementById("genreProgress").style.width = pctGenero + "%";
        document.getElementById("genreDot").style.left = pctGenero + "%";
        document.getElementById("genreInfo").innerText = 
            formatarHMS(totalTocado) + " / " + formatarHMS(tempoTotalGenero);
    }

    // Barra geral
    if (tempoTotalGeral > 0) {
        const totalGeral = tempoGeralTocado + (player.currentTime || 0);
        const pctGeral = Math.min((totalGeral / tempoTotalGeral) * 100, 100);

        document.getElementById("globalProgress").style.width = pctGeral + "%";
        document.getElementById("globalDot").style.left = pctGeral + "%";
        document.getElementById("globalInfo").innerText = 
            formatarHMS(totalGeral) + " / " + formatarHMS(tempoTotalGeral);
    }
});

// Quando m√∫sica termina
player.addEventListener("ended", () => {
    if (!tocandoDivulgacao) {
        const dur = player.duration || 0;
        if (!isNaN(dur) && isFinite(dur)) {
            tempoGeneroTocado += dur;
            tempoGeralTocado += dur;
        }
        contadorMusicas++;
    }

    if (tocandoDivulgacao) {
        tocandoDivulgacao = false;
        tocarProxima();
        return;
    }

    // A cada 5 m√∫sicas, toca divulga√ß√£o
    if (contadorMusicas > 0 && contadorMusicas % 5 === 0) {
        tocarDivulgacao();
        return;
    }

    tocarProxima();
});

// Loading states
player.addEventListener("loadstart", () => {
    document.getElementById("trackName").innerText = "Carregando...";
    document.getElementById("trackName").classList.add("loading");
    document.getElementById("musicProgress").style.width = "0%";
    document.getElementById("musicDot").style.left = "0%";
});

player.addEventListener("canplay", () => {
    playBtn.src = "icon/pause.png";
});

player.addEventListener("playing", () => {
    document.getElementById("trackName").classList.remove("loading");
    if (musicaAtualNome) {
        document.getElementById("trackName").innerText = musicaAtualNome;
    }
});

player.addEventListener("error", (e) => {
    console.error("Erro no player:", e);
    document.getElementById("trackName").innerText = "Erro ao carregar";
    document.getElementById("trackName").classList.remove("loading");
    // Tenta pr√≥xima m√∫sica ap√≥s erro
    setTimeout(() => tocarProxima(), 2000);
});

// Click na barra de progresso para seek
document.getElementById("musicProgressContainer").addEventListener("click", (e) => {
    if (!player.duration) return;
    const rect = e.currentTarget.getBoundingClientRect();
    const pct = (e.clientX - rect.left) / rect.width;
    player.currentTime = pct * player.duration;
});

// Inicializar visualizador com estado idle
drawVisualizer();

</script>
</body>
</html>
