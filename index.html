<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="icon/favicon.png">
    <title>Radio Online - Pinheirinho Celulares</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: #121212;
            color: #fff;
            font-family: 'Segoe UI', Arial, sans-serif;
            min-height: 100vh;
            padding-top: 64px;
            padding-bottom: 140px;
        }

        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 64px;
            background: linear-gradient(90deg, #007bff, #ff7a00);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 1000;
        }

        .top-bar img { height: 40px; cursor: pointer; }
        .top-bar img#loginIcon { width: 36px; height: 36px; }

        .center {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
            padding: 30px 20px;
        }

        .center h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(90deg, #007bff, #ff7a00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .center p { font-size: 1rem; color: #b3b3b3; }

        .visualizer-container {
            width: 100%;
            max-width: 1100px;
            height: 280px;
            margin: 30px auto;
            background: rgba(0,0,0,0.4);
            border-radius: 16px;
            overflow: hidden;
            position: relative;
        }

        #visualizer { width: 100%; height: 100%; display: block; }

        .visualizer-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60%;
            background: linear-gradient(to top, #121212, transparent);
            pointer-events: none;
        }

        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #181818;
            border-top: 1px solid #282828;
            padding: 12px 16px;
            z-index: 1000;
        }

        .player-wrapper {
            width: 100%;
            max-width: 1800px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            align-items: center;
            gap: 16px;
        }

        .controls-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .controls img {
            width: 36px;
            height: 36px;
            cursor: pointer;
            opacity: 0.85;
            transition: all 0.2s ease;
        }

        .controls img:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .controls img.main-btn {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #007bff, #ff7a00);
            border-radius: 50%;
            padding: 10px;
            opacity: 1;
        }

        .volume-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .volume-controls img {
            width: 28px;
            height: 28px;
            cursor: pointer;
            opacity: 0.85;
        }

        .track-section { min-width: 0; }

        .now-playing {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .track-art {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #007bff, #ff7a00);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .track-art span { font-size: 24px; }

        .track-details { flex: 1; min-width: 0; }

        .track-name {
            font-size: 14px;
            font-weight: 500;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }

        .track-genre { font-size: 12px; color: #b3b3b3; }

        .progress-section { width: 100%; }

        .progress-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .time-label {
            font-size: 11px;
            color: #a7a7a7;
            min-width: 40px;
        }

        .time-label.right { text-align: right; }

        .progress-container {
            flex: 1;
            position: relative;
            height: 4px;
            background: #404040;
            border-radius: 2px;
        }

        .progress {
            height: 100%;
            width: 0%;
            background: #fff;
            border-radius: 2px;
        }

        .dot {
            position: absolute;
            top: 50%;
            left: 0%;
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
        }

        .progress-container:hover .dot { opacity: 1; }
        .progress-container:hover .progress { background: linear-gradient(90deg, #007bff, #ff7a00); }

        .extra-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }

        .info-bar {
            background: #282828;
            border-radius: 8px;
            padding: 8px 12px;
            width: 100%;
            max-width: 280px;
        }

        .info-bar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .info-bar-title {
            font-size: 11px;
            color: #b3b3b3;
            text-transform: uppercase;
        }

        .info-bar-time { font-size: 11px; color: #a7a7a7; }
        .info-bar .progress-container { height: 3px; }

        #loginBox {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #282828;
            padding: 32px;
            border-radius: 8px;
            display: none;
            flex-direction: column;
            gap: 16px;
            z-index: 2000;
            width: 90%;
            max-width: 320px;
        }

        #loginBox h3 {
            text-align: center;
            font-size: 24px;
            font-weight: 700;
        }

        #loginBox input {
            padding: 14px 16px;
            border: none;
            border-radius: 4px;
            background: #3e3e3e;
            color: #fff;
            font-size: 16px;
            width: 100%;
        }

        #loginBox button {
            padding: 14px;
            background: linear-gradient(90deg, #007bff, #ff7a00);
            border: none;
            color: #fff;
            border-radius: 500px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
        }

        #genrePanel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .genre-box {
            background: #282828;
            padding: 24px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
        }

        .genre-box h3 {
            text-align: center;
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        #genreList {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 16px;
        }

        #genreList button {
            background: #3e3e3e;
            color: #fff;
            padding: 12px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        #genreList button:hover { background: linear-gradient(90deg, #007bff, #ff7a00); }

        .genre-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .genre-actions button {
            padding: 14px;
            background: #3e3e3e;
            border: none;
            color: #fff;
            border-radius: 500px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .genre-actions button:first-child { background: linear-gradient(90deg, #007bff, #ff7a00); }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            display: none;
        }

        @media (max-width: 768px) {
            body { padding-bottom: 280px; }
            .player-wrapper { grid-template-columns: 1fr; gap: 12px; }
            .controls-section { order: 1; }
            .track-section { order: 0; }
            .extra-section { order: 2; align-items: stretch; }
            .info-bar { max-width: none; }
            .now-playing { justify-content: center; }
        }

        @media (max-width: 480px) {
            body { padding-bottom: 300px; }
            .center h1 { font-size: 1.8rem; }
            .visualizer-container { height: 180px; }
            .now-playing { flex-direction: column; text-align: center; }
            .track-details { text-align: center; }
            .controls img { width: 32px; height: 32px; }
            .controls img.main-btn { width: 44px; height: 44px; }
            #genreList { grid-template-columns: 1fr; }
        }

        .loading { animation: pulse 1.5s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
    </style>
</head>
<body>

<!-- PAINEL DE GENEROS -->
<div id="genrePanel">
    <div class="genre-box">
        <h3>Selecionar Genero</h3>
        <div id="genreList"></div>
        <div class="genre-actions">
            <button onclick="autoGenre()">Selecao Automatica</button>
            <button onclick="closeGenrePanel()">Fechar</button>
        </div>
    </div>
</div>

<!-- OVERLAY -->
<div class="overlay" id="overlay"></div>

<!-- BARRA SUPERIOR -->
<div class="top-bar">
    <img src="imagens/logo.png" alt="Logo" onclick="location.reload()">
    <img id="loginIcon" src="icon/login.png" onclick="toggleLogin()" title="Login Admin">
</div>

<!-- AREA CENTRAL -->
<div class="center">
    <h1>Radio Online</h1>
    <p>Pinheirinho Celulares</p>
    
    <!-- VISUALIZADOR DE BATIDAS -->
    <div class="visualizer-container">
        <canvas id="visualizer"></canvas>
        <div class="visualizer-overlay"></div>
    </div>
</div>

<!-- BARRA INFERIOR -->
<div class="bottom-bar">
    <div class="player-wrapper">

        <!-- TRACK INFO -->
        <div class="track-section">
            <div class="now-playing">
                <div class="track-art">
                    <span>&#127925;</span>
                </div>
                <div class="track-details">
                    <div class="track-name" id="trackName">Nenhuma musica</div>
                    <div class="track-genre">Genero: <span id="genreName">---</span></div>
                </div>
            </div>
        </div>

        <!-- CONTROLES CENTRAIS -->
        <div class="controls-section">
            <div class="controls">
                <img id="genreBtn" src="icon/genero.png" onclick="openGenres()" style="display:none;" title="Generos">
                <img id="nextBtn" src="icon/proximo.png" onclick="nextMusic()" style="display:none;" title="Proxima">
                <img id="playBtn" src="icon/play.png" onclick="togglePlay()" class="main-btn" title="Play/Pause">
            </div>
            
            <!-- BARRA DE PROGRESSO DA MUSICA -->
            <div class="progress-section">
                <div class="progress-row">
                    <span class="time-label" id="currentTime">0:00</span>
                    <div class="progress-container" id="musicProgressContainer">
                        <div class="progress" id="musicProgress"></div>
                        <div class="dot" id="musicDot"></div>
                    </div>
                    <span class="time-label right" id="totalTime">0:00</span>
                </div>
            </div>

            <!-- VOLUME -->
            <div class="volume-controls">
                <img src="icon/diminuir.png" onclick="volumeDown()" title="Diminuir">
                <img id="muteBtn" src="icon/mute.png" onclick="toggleMute()" title="Mudo">
                <img src="icon/aumenta.png" onclick="volumeUp()" title="Aumentar">
            </div>
        </div>

        <!-- BARRAS DE INFO -->
        <div class="extra-section">
            <div class="info-bar">
                <div class="info-bar-header">
                    <span class="info-bar-title">Genero</span>
                    <span class="info-bar-time" id="genreInfo">00:00:00 / 00:00:00</span>
                </div>
                <div class="progress-container">
                    <div class="progress" id="genreProgress"></div>
                    <div class="dot" id="genreDot"></div>
                </div>
            </div>

            <div class="info-bar">
                <div class="info-bar-header">
                    <span class="info-bar-title">Total Geral</span>
                    <span class="info-bar-time" id="globalInfo">00:00:00 / 00:00:00</span>
                </div>
                <div class="progress-container">
                    <div class="progress" id="globalProgress"></div>
                    <div class="dot" id="globalDot"></div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- LOGIN BOX -->
<div id="loginBox">
    <h3>Login Admin</h3>
    <input id="user" placeholder="Usuario" autocomplete="username">
    <input id="pass" type="password" placeholder="Senha" autocomplete="current-password">
    <button onclick="login()">Entrar</button>
</div>

<!-- AUDIO ELEMENT -->
<audio id="player" crossorigin="anonymous"></audio>

<script>
var player = document.getElementById("player");
var loginBox = document.getElementById("loginBox");
var loginIcon = document.getElementById("loginIcon");
var overlay = document.getElementById("overlay");
var nextBtn = document.getElementById("nextBtn");
var genreBtn = document.getElementById("genreBtn");
var playBtn = document.getElementById("playBtn");
var muteBtnEl = document.getElementById("muteBtn");
var userInput = document.getElementById("user");
var passInput = document.getElementById("pass");
var genrePanel = document.getElementById("genrePanel");
var genreList = document.getElementById("genreList");

var isAdmin = false;
var tempoTotalGenero = 0;
var tempoGeneroTocado = 0;
var tempoTotalGeral = 0;
var tempoGeralTocado = 0;
var generoAtual = "";
var musicasTocadas = [];
var contadorMusicas = 0;
var tocandoDivulgacao = false;
var musicaAtualNome = "";

// NOVAS VARIÁVEIS PARA CONTROLE DE GÊNEROS
var generosTocados = [];  // Array para rastrear gêneros tocados no ciclo atual
var ultimosDoisGeneros = [];  // Array para armazenar os últimos 2 gêneros

var audioContext = null;
var analyser = null;
var dataArray = null;
var isVisualizerInitialized = false;

var musicas = {
    "Eletronica": [
        "Amine_Edge_Dance_Lost.mp3",
        "Diskera_Blackartel.mp3",
        "First_Time.mp3",
        "Gabss_Lost.mp3",
        "House_Every_Weekend.mp3",
        "Hungry_for_the_power.mp3",
        "Naughty_Water.mp3",
        "No_No_No.mp3",
        "Noir_Haze_Around.mp3",
        "Rooftime_I_Will_Find.mp3",
        "Slow_Down.mp3",
        "Tiesto_The_Business.mp3",
        "World_Hold_On.mp3"
    ],
    "Sertanejo": [
        "Barulho_do_Foguete.mp3",
        "Bebu_Liguei.mp3",
        "Bloqueado.mp3",
        "Ce_Ta_Preparada.mp3",
        "Cheirosa.mp3",
        "Ciumera.mp3",
        "Daqui_Pra_Sempre.mp3",
        "Decide_Ai.mp3",
        "Dois_Triste.mp3",
        "Esquema_Preferido.mp3",
        "Eu_Sei_De_Cor.mp3",
        "Flor_E_O_Beija_Flor.mp3",
        "Gosta_de_Rua.mp3",
        "Intencao.mp3",
        "Largando_as_Tacas.mp3",
        "Leao.mp3",
        "Lencol_Dobrado.mp3",
        "Mal_Feito.mp3",
        "Medo_Bobo.mp3",
        "O_Nosso_Santo_Bateu.mp3",
        "S_de_Saudade.mp3",
        "Saudade_Burra.mp3",
        "Saudade_Proibida.mp3",
        "Stats_que_eu_nao_queria.mp3",
        "Todo_mundo_vai_sofrer.mp3",
        "Tudo_Que_Voce_Quiser.mp3",
        "Vidinha_de_Balada.mp3",
        "Volta_por_Baixo.mp3"
    ],
    "Pop": [
        "7_Seconds.mp3",
        "Addicted.mp3",
        "Bad_Habits.mp3",
        "Drums.mp3",
        "Ferrari.mp3",
        "Imagination.mp3",
        "In_Da_Club.mp3",
        "Kiss_me.mp3",
        "Kungs_Substitution.mp3",
        "Lose_Control.mp3",
        "Me_Halfway.mp3",
        "Mi_Gente.mp3",
        "Mr_Probz_Waves.mp3",
        "My_Heart.mp3",
        "Ocean_Drive.mp3",
        "Rivers_Lykke.mp3",
        "The_Better.mp3",
        "The_People.mp3",
        "The_Stars.mp3",
        "Thinking_About.mp3",
        "Unholy.mp3",
        "Die_With.mp3",
        "Handle_Me.mp3",
        "In_The_End.mp3",
        "Last_Night.mp3",
        "Memories.mp3",
        "Only_Girl.mp3",
        "Ordinary.mp3",
        "The_Fate.mp3",
        "Umbrella.mp3",
        "Whats_My.mp3",
        "With_You.mp3",
        "Wonderful.mp3",
        "Calm_Down.mp3",
        "Human.mp3",
        "Old_Town_Road.mp3",
        "Stay.mp3",
        "Sunflower.mp3"
    ],
    "Pagode": [
        "Aquele_Lugar.mp3",
        "A_Gente_Tem_Tudo_Ver.mp3",
        "Bebe_Vem_Me_Procura.mp3",
        "Deixa_Acontecer.mp3",
        "Deixa_em_Off.mp3",
        "Mais_Jejum_de_Amor.mp3",
        "Melhor_eu_ir_Ligando_os_Fatos.mp3",
        "P_do_Pecado.mp3",
        "Pela_Ultima_Vez.mp3",
        "Pixote_Inseguranca.mp3",
        "Tarde_Demais.mp3",
        "Aquele_Beijo.mp3",
        "Camisa_10.mp3",
        "Duvido.mp3",
        "Eu_Nunca_Amei.mp3",
        "Mais_do_Mesmo.mp3",
        "Melhor_Amigo.mp3",
        "Surpresa_de_Amor.mp3"
    ],
    "Anos80": [
        "On_Your_Side.mp3",
        "Atlantis.mp3",
        "Be_My_Lover.mp3",
        "Big_in_Japan.mp3",
        "Boogie_Wonderland.mp3",
        "Break_Free.mp3",
        "Caribbean_Queen.mp3",
        "Cheri_Cheri_Lady.mp3",
        "Funkytown.mp3",
        "Gimme_Gimme.mp3",
        "Girls_Just.mp3",
        "Happy_Nation.mp3",
        "If_You_Want.mp3",
        "Isla_Bonita.mp3",
        "la_Playa.mp3",
        "Like_Prayer.mp3",
        "Mr_Vain.mp3",
        "No_Limit.mp3",
        "Return_Mack.mp3",
        "Rhythm_Dancer.mp3",
        "Self_Control.mp3",
        "Somebody.mp3",
        "Sweet_Dreams.mp3",
        "Voyage_Voyage.mp3",
        "You_re_My.mp3"
    ],
    "Divulgacao": [
        "promo1.mp3",
        "promo2.mp3",
        "promo3.mp3",
        "promo4.mp3",
        "promo5.mp3"
    ]
};

function initVisualizer() {
    if (isVisualizerInitialized) return;
    try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        var source = audioContext.createMediaElementSource(player);
        source.connect(analyser);
        analyser.connect(audioContext.destination);
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        isVisualizerInitialized = true;
        drawVisualizer();
    } catch (e) {
        console.warn("Visualizador nao disponivel:", e);
    }
}

function drawVisualizer() {
    var canvas = document.getElementById("visualizer");
    var ctx = canvas.getContext("2d");
    canvas.width = canvas.offsetWidth * 2;
    canvas.height = canvas.offsetHeight * 2;
    ctx.scale(2, 2);
    var width = canvas.offsetWidth;
    var height = canvas.offsetHeight;

    function draw() {
        requestAnimationFrame(draw);
        if (!analyser || !dataArray) {
            ctx.fillStyle = "rgba(18, 18, 18, 0.3)";
            ctx.fillRect(0, 0, width, height);
            var barCount = 64;
            var barWidth = width / barCount - 2;
            for (var i = 0; i < barCount; i++) {
                var barHeight = 5 + Math.sin(Date.now() / 500 + i * 0.2) * 3;
                var x = i * (barWidth + 2);
                var gradient = ctx.createLinearGradient(0, height - barHeight, 0, height);
                gradient.addColorStop(0, "#007bff");
                gradient.addColorStop(1, "#ff7a00");
                ctx.fillStyle = gradient;
                ctx.fillRect(x, height - barHeight, barWidth, barHeight);
            }
            return;
        }
        analyser.getByteFrequencyData(dataArray);
        ctx.fillStyle = "rgba(18, 18, 18, 0.3)";
        ctx.fillRect(0, 0, width, height);
        var barCount = dataArray.length;
        var barWidth = width / barCount - 1;
        for (var i = 0; i < barCount; i++) {
            var barHeight = (dataArray[i] / 255) * height * 0.9;
            var x = i * (barWidth + 1);
            var gradient = ctx.createLinearGradient(0, height - barHeight, 0, height);
            gradient.addColorStop(0, "#007bff");
            gradient.addColorStop(0.5, "#00c3ff");
            gradient.addColorStop(1, "#ff7a00");
            ctx.fillStyle = gradient;
            ctx.fillRect(x, height - barHeight, barWidth, barHeight);
        }
    }
    draw();
}

window.addEventListener("resize", function() {
    var canvas = document.getElementById("visualizer");
    if (canvas) {
        canvas.width = canvas.offsetWidth * 2;
        canvas.height = canvas.offsetHeight * 2;
    }
});

function toggleLogin() {
    if (isAdmin) {
        logout();
    } else {
        openLogin();
    }
}

function openLogin() {
    userInput.value = "";
    passInput.value = "";
    loginBox.style.display = "flex";
    overlay.style.display = "block";
    userInput.focus();
}

function login() {
    if (userInput.value === "admin" && passInput.value === "1234") {
        isAdmin = true;
        nextBtn.style.display = "block";
        genreBtn.style.display = "block";
        loginIcon.src = "icon/sair.png";
        loginBox.style.display = "none";
        overlay.style.display = "none";
        userInput.value = "";
        passInput.value = "";
    } else {
        alert("Usuario ou senha invalidos");
        passInput.value = "";
        passInput.focus();
    }
}

function logout() {
    isAdmin = false;
    nextBtn.style.display = "none";
    genreBtn.style.display = "none";
    loginIcon.src = "icon/login.png";
    loginBox.style.display = "none";
    overlay.style.display = "none";
}

passInput.addEventListener("keypress", function(e) {
    if (e.key === "Enter") login();
});

overlay.addEventListener("click", function() {
    loginBox.style.display = "none";
    overlay.style.display = "none";
});

function togglePlay() {
    if (!player.src) {
        iniciarRadio();
        return;
    }
    if (player.paused) {
        player.play();
        if (audioContext && audioContext.state === "suspended") {
            audioContext.resume();
        }
        playBtn.src = "icon/pause.png";
    } else {
        player.pause();
        playBtn.src = "icon/play.png";
    }
}

function toggleMute() {
    player.muted = !player.muted;
    if (player.muted) {
        muteBtnEl.src = "icon/volume.png";
    } else {
        muteBtnEl.src = "icon/mute.png";
    }
}

function volumeUp() { player.volume = Math.min(1, player.volume + 0.1); }
function volumeDown() { player.volume = Math.max(0, player.volume - 0.1); }
function nextMusic() { player.dispatchEvent(new Event("ended")); }

function iniciarRadio() {
    initVisualizer();
    calcularTempoGeral();
    escolherGeneroAutomatico();
}

// FUNÇÃO ATUALIZADA PARA SELEÇÃO AUTOMÁTICA DE GÊNEROS
function escolherGeneroAutomatico() {
    var generos = Object.keys(musicas).filter(function(g) { return g !== "Divulgacao"; });
    
    // Verificar se todos os gêneros já foram tocados
    if (generosTocados.length >= generos.length) {
        console.log("Todos os generos foram tocados! Reiniciando ciclo...");
        // Zerar contadores e reiniciar
        generosTocados = [];
        tempoGeralTocado = 0;
        resetarBarraGeral();
    }
    
    // Filtrar gêneros disponíveis
    var generosDisponiveis = generos.filter(function(g) {
        // Não pode ser um dos já tocados neste ciclo
        if (generosTocados.indexOf(g) !== -1) return false;
        // Não pode ser um dos últimos 2 gêneros
        if (ultimosDoisGeneros.indexOf(g) !== -1) return false;
        return true;
    });
    
    // Se não houver gêneros disponíveis (caso extremo), limpar restrições dos últimos 2
    if (generosDisponiveis.length === 0) {
        console.log("Nenhum genero disponivel, liberando restricoes...");
        generosDisponiveis = generos.filter(function(g) {
            return generosTocados.indexOf(g) === -1;
        });
    }
    
    // Se ainda não houver, reiniciar completamente
    if (generosDisponiveis.length === 0) {
        generosTocados = [];
        ultimosDoisGeneros = [];
        generosDisponiveis = generos;
    }
    
    // Selecionar aleatoriamente dos disponíveis
    var novoGenero = generosDisponiveis[Math.floor(Math.random() * generosDisponiveis.length)];
    
    // Atualizar controles
    generoAtual = novoGenero;
    generosTocados.push(novoGenero);
    
    // Atualizar lista dos últimos 2 gêneros
    ultimosDoisGeneros.push(novoGenero);
    if (ultimosDoisGeneros.length > 2) {
        ultimosDoisGeneros.shift();  // Remove o mais antigo
    }
    
    console.log("Genero selecionado:", novoGenero);
    console.log("Generos tocados no ciclo:", generosTocados);
    console.log("Ultimos 2 generos:", ultimosDoisGeneros);
    
    musicasTocadas = [];
    contadorMusicas = 0;
    tempoGeneroTocado = 0;
    resetarBarraGenero();
    document.getElementById("genreName").innerText = generoAtual;
    calcularTempoGenero(generoAtual, function() {
        tocarProxima();
    });
}

function escolherGeneroManual(genero) {
    closeGenrePanel();
    generoAtual = genero;
    musicasTocadas = [];
    contadorMusicas = 0;
    tempoGeneroTocado = 0;
    tempoGeralTocado = 0;
    tocandoDivulgacao = false;
    
    // Reiniciar controles de gêneros
    generosTocados = [genero];
    ultimosDoisGeneros = [genero];
    
    resetarBarraGenero();
    resetarBarraGeral();
    document.getElementById("genreName").innerText = generoAtual;
    calcularTempoGenero(generoAtual, function() {
        calcularTempoGeral(function() {
            tocarProxima();
        });
    });
}

function resetarBarraGenero() {
    document.getElementById("genreProgress").style.width = "0%";
    document.getElementById("genreDot").style.left = "0%";
    document.getElementById("genreInfo").innerText = "00:00:00 / 00:00:00";
}

function resetarBarraGeral() {
    document.getElementById("globalProgress").style.width = "0%";
    document.getElementById("globalDot").style.left = "0%";
    document.getElementById("globalInfo").innerText = "00:00:00 / 00:00:00";
}

function tocarProxima() {
    if (musicasTocadas.length >= musicas[generoAtual].length) {
        console.log("Genero " + generoAtual + " finalizado. Mudando...");
        escolherGeneroAutomatico();
        return;
    }
    var musica;
    var listaGenero = musicas[generoAtual];
    do {
        musica = listaGenero[Math.floor(Math.random() * listaGenero.length)];
    } while (musicasTocadas.indexOf(musica) !== -1 && musicasTocadas.length < listaGenero.length);
    musicasTocadas.push(musica);
    tocarMusica(generoAtual, musica);
}

function tocarMusica(genero, arquivo) {
    musicaAtualNome = arquivo.replace(/_/g, " ").replace(".mp3", "");
    document.getElementById("trackName").innerText = "Carregando...";
    document.getElementById("trackName").classList.add("loading");
    var caminho = "musicas/" + genero + "/" + arquivo;
    console.log("Tocando:", caminho);
    player.src = caminho;
    player.load();
    player.play().catch(function(e) {
        console.error("Erro ao tocar:", e);
        setTimeout(function() { tocarProxima(); }, 1000);
    });
    playBtn.src = "icon/pause.png";
}

function tocarDivulgacao() {
    var lista = musicas["Divulgacao"];
    if (!lista || lista.length === 0) {
        tocarProxima();
        return;
    }
    tocandoDivulgacao = true;
    var promo = lista[Math.floor(Math.random() * lista.length)];
    tocarMusica("Divulgacao", promo);
}

function formatar(t) {
    if (isNaN(t) || !isFinite(t)) return "0:00";
    var m = Math.floor(t / 60);
    var s = Math.floor(t % 60).toString();
    if (s.length < 2) s = "0" + s;
    return m + ":" + s;
}

function formatarHMS(t) {
    if (isNaN(t) || !isFinite(t)) return "00:00:00";
    var h = Math.floor(t / 3600).toString();
    var m = Math.floor((t % 3600) / 60).toString();
    var s = Math.floor(t % 60).toString();
    if (h.length < 2) h = "0" + h;
    if (m.length < 2) m = "0" + m;
    if (s.length < 2) s = "0" + s;
    return h + ":" + m + ":" + s;
}

function calcularTempoGenero(genero, callback) {
    tempoTotalGenero = 0;
    var lista = musicas[genero];
    if (!lista || lista.length === 0) {
        document.getElementById("genreInfo").innerText = "00:00:00 / 00:00:00";
        if (callback) callback();
        return;
    }
    var processadas = 0;
    var total = lista.length;
    lista.forEach(function(musica) {
        var caminho = "musicas/" + genero + "/" + musica;
        var audioTemp = new Audio(caminho);
        var finalizar = function() {
            processadas++;
            if (processadas === total) {
                document.getElementById("genreInfo").innerText = "00:00:00 / " + formatarHMS(tempoTotalGenero);
                if (callback) callback();
            }
        };
        audioTemp.addEventListener("loadedmetadata", function() {
            if (!isNaN(audioTemp.duration) && isFinite(audioTemp.duration)) {
                tempoTotalGenero += audioTemp.duration;
            }
            finalizar();
        });
        audioTemp.addEventListener("error", function() {
            console.warn("Erro ao carregar:", caminho);
            finalizar();
        });
        setTimeout(function() {
            if (processadas < total) finalizar();
        }, 5000);
    });
}

function calcularTempoGeral(callback) {
    tempoTotalGeral = 0;
    var generos = Object.keys(musicas).filter(function(g) { return g !== "Divulgacao"; });
    var processadas = 0;
    var totalMusicas = 0;
    generos.forEach(function(genero) {
        totalMusicas += musicas[genero].length;
    });
    if (totalMusicas === 0) {
        if (callback) callback();
        return;
    }
    generos.forEach(function(genero) {
        musicas[genero].forEach(function(musica) {
            var caminho = "musicas/" + genero + "/" + musica;
            var audioTemp = new Audio(caminho);
            var finalizar = function() {
                processadas++;
                if (processadas === totalMusicas) {
                    document.getElementById("globalInfo").innerText = "00:00:00 / " + formatarHMS(tempoTotalGeral);
                    if (callback) callback();
                }
            };
            audioTemp.addEventListener("loadedmetadata", function() {
                if (!isNaN(audioTemp.duration) && isFinite(audioTemp.duration)) {
                    tempoTotalGeral += audioTemp.duration;
                }
                finalizar();
            });
            audioTemp.addEventListener("error", finalizar);
            setTimeout(function() {
                if (processadas < totalMusicas) finalizar();
            }, 10000);
        });
    });
}

function openGenres() {
    if (!isAdmin) return;
    genreList.innerHTML = "";
    Object.keys(musicas).forEach(function(genero) {
        if (genero === "Divulgacao") return;
        var btn = document.createElement("button");
        btn.innerText = genero;
        btn.onclick = function() { escolherGeneroManual(genero); };
        genreList.appendChild(btn);
    });
    genrePanel.style.display = "flex";
}

function closeGenrePanel() {
    genrePanel.style.display = "none";
}

function autoGenre() {
    closeGenrePanel();
    tempoGeralTocado = 0;
    generosTocados = [];
    ultimosDoisGeneros = [];
    resetarBarraGeral();
    escolherGeneroAutomatico();
}

player.addEventListener("timeupdate", function() {
    if (!player.duration || isNaN(player.duration)) return;
    var pct = (player.currentTime / player.duration) * 100;
    document.getElementById("musicProgress").style.width = pct + "%";
    document.getElementById("musicDot").style.left = pct + "%";
    document.getElementById("currentTime").innerText = formatar(player.currentTime);
    document.getElementById("totalTime").innerText = formatar(player.duration);
    if (tempoTotalGenero > 0) {
        var totalTocado = tempoGeneroTocado + (player.currentTime || 0);
        var pctGenero = Math.min((totalTocado / tempoTotalGenero) * 100, 100);
        document.getElementById("genreProgress").style.width = pctGenero + "%";
        document.getElementById("genreDot").style.left = pctGenero + "%";
        document.getElementById("genreInfo").innerText = formatarHMS(totalTocado) + " / " + formatarHMS(tempoTotalGenero);
    }
    if (tempoTotalGeral > 0) {
        var totalGeral = tempoGeralTocado + (player.currentTime || 0);
        var pctGeral = Math.min((totalGeral / tempoTotalGeral) * 100, 100);
        document.getElementById("globalProgress").style.width = pctGeral + "%";
        document.getElementById("globalDot").style.left = pctGeral + "%";
        document.getElementById("globalInfo").innerText = formatarHMS(totalGeral) + " / " + formatarHMS(tempoTotalGeral);
    }
});

player.addEventListener("ended", function() {
    if (!tocandoDivulgacao) {
        var dur = player.duration || 0;
        if (!isNaN(dur) && isFinite(dur)) {
            tempoGeneroTocado += dur;
            tempoGeralTocado += dur;
        }
        contadorMusicas++;
    }
    if (tocandoDivulgacao) {
        tocandoDivulgacao = false;
        tocarProxima();
        return;
    }
    if (contadorMusicas > 0 && contadorMusicas % 5 === 0) {
        tocarDivulgacao();
        return;
    }
    tocarProxima();
});

player.addEventListener("loadstart", function() {
    document.getElementById("trackName").innerText = "Carregando...";
    document.getElementById("trackName").classList.add("loading");
    document.getElementById("musicProgress").style.width = "0%";
    document.getElementById("musicDot").style.left = "0%";
});

player.addEventListener("canplay", function() {
    playBtn.src = "icon/pause.png";
});

player.addEventListener("playing", function() {
    document.getElementById("trackName").classList.remove("loading");
    if (musicaAtualNome) {
        document.getElementById("trackName").innerText = musicaAtualNome;
    }
});

player.addEventListener("error", function(e) {
    console.error("Erro no player:", e);
    document.getElementById("trackName").innerText = "Erro ao carregar";
    document.getElementById("trackName").classList.remove("loading");
    setTimeout(function() { tocarProxima(); }, 2000);
});

// REMOVIDO: Event listener de click na barra de progresso
// A interação com o mouse foi desabilitada conforme solicitado
/*
document.getElementById("musicProgressContainer").addEventListener("click", function(e) {
    if (!player.duration) return;
    var rect = e.currentTarget.getBoundingClientRect();
    var pct = (e.clientX - rect.left) / rect.width;
    player.currentTime = pct * player.duration;
});
*/

drawVisualizer();
</script>
</body>
</html>
